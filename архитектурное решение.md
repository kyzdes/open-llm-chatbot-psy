# Архитектурное решение — FreePsy

## 1. Стек технологий

| Компонент | Технология | Обоснование |
|-----------|-----------|-------------|
| Язык | Python 3.11+ | Богатая экосистема для Telegram-ботов |
| Telegram-фреймворк | aiogram 3.x | Асинхронный, современный, FSM из коробки |
| HTTP-клиент | aiohttp | Асинхронные запросы к OpenRouter |
| База данных | SQLite + aiosqlite | Простота для MVP, нет внешних зависимостей |
| LLM API | OpenRouter | Единый API для множества бесплатных моделей |
| Конфигурация | python-dotenv | Безопасное хранение секретов |

## 2. Архитектура

```
Telegram ← aiogram → Handlers → Services → OpenRouter API
                         ↓            ↓
                    Middlewares    SQLite DB
                    (rate limit,   (users, messages,
                     crisis scan)   mood, settings)
```

### Слои:
1. **Handlers** — обработка команд и сообщений
2. **Middlewares** — rate limiting, быстрый crisis scan
3. **Services** — бизнес-логика (LLM, история, кризис, аналитика)
4. **Repositories** — доступ к данным (CRUD для каждой таблицы)
5. **DB Engine** — управление соединениями, WAL mode
6. **Utils** — форматирование (md→HTML), промпты, константы
7. **Keyboards** — inline-клавиатуры (mood, reset, выбор модели)

## 3. Схема БД (SQLite)

### users
- `user_id` INTEGER PRIMARY KEY — Telegram user ID
- `username` TEXT
- `first_name` TEXT
- `language_code` TEXT
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `is_blocked` INTEGER DEFAULT 0

### conversation_messages
- `id` INTEGER PRIMARY KEY AUTOINCREMENT
- `user_id` INTEGER REFERENCES users(user_id)
- `role` TEXT — 'system' | 'user' | 'assistant'
- `content` TEXT
- `tokens_est` INTEGER
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### mood_entries
- `id` INTEGER PRIMARY KEY AUTOINCREMENT
- `user_id` INTEGER REFERENCES users(user_id)
- `score` INTEGER CHECK(score BETWEEN 1 AND 10)
- `note` TEXT
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### bot_settings
- `key` TEXT PRIMARY KEY
- `value` TEXT

### crisis_events
- `id` INTEGER PRIMARY KEY AUTOINCREMENT
- `user_id` INTEGER REFERENCES users(user_id)
- `trigger` TEXT — 'keyword' | 'llm'
- `matched` TEXT — сработавшее слово/фраза
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

## 4. Обработка сообщений (основной поток)

```
Пользователь → текст
  ↓
[Middleware: Rate Limit] — отклонить если превышен лимит
  ↓
[Middleware: Crisis Scan] — быстрая проверка ключевых слов
  ↓
[Handler: therapy]
  1. Сохранить сообщение в БД
  2. Если crisis_detected → показать горячие линии
  3. build_history() — скользящее окно ~100K токенов
  4. Запустить typing keep-alive (каждые 4с)
  5. LLM запрос → OpenRouter
  6. Strip <think> блоков из ответа
  7. Сохранить ответ в БД
  8. Разбить на чанки (≤3500 символов, до HTML-конвертации)
  9. Конвертировать Markdown→HTML (md_to_html + sanitize_html)
  10. Отправить пользователю (parse_mode=HTML, fallback на plain text)
```

## 5. Crisis Detection (2 слоя)

**Слой 1 — Keyword scan (middleware)**:
- Проверка по словарю ключевых слов (рус/англ)
- Мгновенный результат, выполняется до handler
- Флаг `crisis_detected` в data

**Слой 2 — LLM check (в handler, при необходимости)**:
- Отдельный prompt для оценки уровня кризиса
- Более точный, но медленный

## 6. Скользящее окно истории

- Бюджет: ~100K токенов (из 164K контекста модели)
- Оценка токенов: `len(text) / 3` для русского текста
- Системный промпт всегда включён
- Старые сообщения обрезаются с начала

## 7. Rate Limiting

- Алгоритм: Token Bucket
- Параметры: 3 burst, 1 токен / 10 секунд
- In-memory (сбрасывается при перезапуске)
- Применяется к каждому user_id отдельно

## 8. Модель по умолчанию

`deepseek/deepseek-r1-0528:free` — 671B параметров, 164K контекстное окно.

Особенности:
- Генерирует `<think>` блоки (reasoning tokens) — удаляем regex'ом
- `include_reasoning: false` в запросе
- Время ответа 30-60с → typing keep-alive

## 9. Динамический выбор модели

Вместо хардкод-списка моделей — запрос `GET /api/v1/models` к OpenRouter API.

- **Фильтрация**: только бесплатные (`pricing.prompt == "0"` и `pricing.completion == "0"`)
- **Кеш**: модульная переменная, TTL 10 минут
- **UI**: inline-клавиатура, текущая модель помечена ✓, максимум 20 кнопок
- **callback_data**: `model:{index}` — индекс в кешированном списке (защита от лимита 64 байта)
- **Валидация**: после выбора — пробный запрос к модели перед сохранением

## 10. Форматирование сообщений

Все сообщения бота используют `parse_mode="HTML"`.

- **Статические сообщения** (промпты, техники, команды): HTML-разметка прямо в константах
- **LLM-ответы**: конвертация Markdown→HTML через `md_to_html()`:
  - `html.escape()` → защита от инъекций
  - ` ```code``` ` → `<pre>`
  - `` `code` `` → `<code>`
  - `**bold**` → `<b>`, `*italic*` → `<i>`
  - `## Header` → `<b>`
- **sanitize_html()**: закрытие незакрытых тегов перед отправкой
- **Fallback**: при `TelegramBadRequest` — отправка без parse_mode

## 11. Меню команд бота

При запуске вызывается `bot.set_my_commands()` — Telegram показывает пользовательские команды через кнопку `/` в поле ввода. Админские команды (`modelchange`, `setprompt`, `resetprompt`) не включены в меню.
