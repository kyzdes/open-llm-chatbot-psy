# PRD — FreePsy: Telegram-бот бесплатный AI-психолог

## 1. Обзор продукта

**FreePsy** — Telegram-бот, предоставляющий бесплатную психологическую поддержку на основе LLM через OpenRouter API. Бот ведёт эмпатичный диалог, распознаёт кризисные ситуации, предлагает терапевтические техники и помогает вести дневник настроения.

## 2. Целевая аудитория

- Русскоязычные пользователи, нуждающиеся в психологической поддержке
- Люди, которые не могут позволить себе визит к психологу
- Пользователи, ищущие анонимную поддержку

## 3. Ключевые функции

### 3.1 Терапевтический диалог
- Эмпатичный AI-психолог на базе LLM (DeepSeek R1 через OpenRouter)
- Полная персистентная история диалогов (SQLite)
- Скользящее окно контекста (~100K токенов из 164K доступных)
- Системный промпт с ролью профессионального психолога
- Краткие ответы (3-5 предложений) — оптимизировано для чтения с телефона

### 3.2 Распознавание кризисных ситуаций
- **Слой 1**: Мгновенная проверка ключевых слов (рус/англ)
- **Слой 2**: LLM-оценка уровня кризиса
- Автоматическое предоставление контактов горячих линий
- Логирование кризисных событий

### 3.3 Терапевтические техники
- `/breathe` — дыхательная техника 4-7-8
- `/ground` — техника заземления 5-4-3-2-1

### 3.4 Дневник настроения
- `/mood` — ввод оценки настроения (1-10) + заметка
- `/diary` — недельная сводка с трендом

### 3.5 Администрирование
- `/modelchange` — выбор LLM-модели из динамического списка бесплатных моделей OpenRouter (inline-клавиатура, только для админа)
- `/setprompt` — задать кастомный системный промпт (админ)
- `/resetprompt` — сбросить системный промпт на стандартный (админ)
- `/reset` — очистка истории диалога (с подтверждением)

### 3.6 UX
- Меню команд бота (кнопка `/` в Telegram показывает список пользовательских команд)
- HTML-форматирование сообщений (вместо Markdown) — надёжный рендеринг жирного, курсива, кода
- Автоконвертация Markdown из LLM-ответов в Telegram HTML с fallback на plain text

## 4. Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие + дисклеймер |
| `/help` | Список команд |
| `/breathe` | Дыхательное упражнение 4-7-8 |
| `/ground` | Техника заземления 5-4-3-2-1 |
| `/mood` | Записать настроение (1-10 + заметка) |
| `/diary` | Сводка настроения за неделю |
| `/reset` | Очистить историю диалога |
| `/modelchange` | Выбрать LLM-модель из списка (админ) |
| `/setprompt` | Задать кастомный системный промпт (админ) |
| `/resetprompt` | Сбросить системный промпт (админ) |

## 5. Нефункциональные требования

- **Безопасность**: API-ключи только в `.env`, никогда в коде
- **Rate Limiting**: Token Bucket (3 burst, 1 сообщение / 10 сек)
- **Таймаут LLM**: 120 секунд (DeepSeek R1 может долго думать)
- **Typing indicator**: Keep-alive каждые 4 сек во время ожидания ответа LLM
- **Форматирование**: HTML parse_mode во всех сообщениях, LLM Markdown конвертируется в HTML
- **Меню команд**: Автоматическая регистрация через `set_my_commands()` при запуске
- **Дисклеймер**: Бот не заменяет профессиональную помощь

## 6. Ограничения и дисклеймеры

- Бот **не является** заменой профессионального психолога
- В кризисных ситуациях бот направляет на горячие линии
- Бот работает на бесплатных LLM-моделях, качество может варьироваться
